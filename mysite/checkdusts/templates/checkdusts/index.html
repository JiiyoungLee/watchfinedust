<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 640px; width: 480px;}
      .infoClass {
        color : black;
        font : 13px bold;
      }
  </style>
  <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
  </script>
</head>
<body>
	<button name = 'crawling_button' id = "crawling_button">update!</button>
  <script>
    $("#crawling_button").click(function() {
     $.ajax({
      type : "GET",
      url : "./",
      success : function(data) {
        console.log(data);
        alert("update!!!");
      }
     }).fail(function() {
      alert('error');
     });
    });
  </script>
	<div id="map"></div>
    <script type="text/javascript">
      var map;
      var infowindowArr = [];
	    function initMap() {
        var dustArr = [];

  		  // initialize google map
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 7,
          center: {lat: 36.141730, lng: 128.098123},
          maxZoom: 13,
          minZoom: 7
        });
        // idle event listener
        map.addListener('idle', function() {
          if (map.getZoom() >= 11) {
            {% for dustInfo in mySet %}
              if ({{ dustInfo.latitude }} > map.getBounds().f.f && {{ dustInfo.latitude }} < map.getBounds().f.b && {{ dustInfo.longitude }} > map.getBounds().b.b && {{ dustInfo.longitude }} < map.getBounds().b.f) {
                dustArr.push({"latitude": {{dustInfo.latitude}}, "longitude" : {{dustInfo.longitude}}, "name": '{{dustInfo.name}}', "dust" : '{{dustInfo.dust}}'});
              }
            {% endfor %}
            setTimeout(makeInfoWindow, 800, dustArr);
            dustArr = [];  
          }
        });
        map.addListener('drag', function() {
          setTimeout(closeInfoWindow, 300);
        });
	    }

      function changeColor(){
        var infoArr = [];
        infoArr = document.getElementsByClassName("infoClass");
        for (let i = 0; i < infoArr.length; i++) {
          if (infoArr[i].innerHTML >= 0 && infoArr[i].innerHTML < 31) {
            infoArr[i].style.color = "#0000cc";
          } else if (infoArr[i].innerHTML >= 31 && infoArr[i].innerHTML < 81) {
            infoArr[i].style.color = "#006666";
          } else if (infoArr[i].innerHTML >= 81 && infoArr[i].innerHTML < 121) {
            infoArr[i].style.color = "#ff9900";
          } else if (infoArr[i].innerHTML >= 121 && infoArr[i].innerHTML < 200) {
            infoArr[i].style.color = "#ff3300";
          } else {
            infoArr[i].style.color = "#ff0000";
          }
        }
      }

      function makeInfoWindow(arr) {
        var infowindow;
        console.log(arr);
        closeInfoWindow();
        for (let i = 0; i < arr.length; i++) {
          infowindow = new google.maps.InfoWindow({
            content: '<div class = "infoClass">' + arr[i].dust + '</div>',
            position: {lat: arr[i].latitude, lng: arr[i].longitude},
            disableAutoPan: true
          });
          console.log(infowindow);
          infowindowArr.push(infowindow);
          infowindow.open(map);
          changeColor();
        }
        console.log("second");
        console.log(infowindowArr);
      }

      function closeInfoWindow() {
        if (infowindowArr.length !== 0) {  
          infowindowArr.forEach(function(item) {
            item.close();
          });
          infowindowArr = [];
        }
      }

      
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCsOSPpmnileVyIhwrNpk0FLcvHrWW3zE&callback=initMap">
    </script>
</body>
</html>
